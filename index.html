<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dropdown from Google Sheets</title>
    <style>
        body { font-family: Arial, sans-serif; }
        select, div { margin-top: 10px; }
        .note-container { margin-top: 10px; }
        .note-item { display: flex; align-items: center; margin-bottom: 5px; }
        .note-item input { margin-right: 5px; }
        
        /* Help Icon Styling */
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            font-size: 14px;
            font-weight: bold;
            color: white;
            background-color: blue;
            border-radius: 50%; /* Circular Shape */
            text-decoration: none;
            margin-left: 8px;
            cursor: pointer;
        }

        .help-icon:hover {
            background-color: darkblue;
        }
    </style>
</head>
<body>

    <h2>Select a State, AHJ, and Utility</h2>
    <label for="state">State:</label>
    <select id="state" onchange="updateAHJAndUtility()">
        <option value="">Select State</option>
    </select>

    <label for="ahj">AHJ:</label>
    <select id="ahj" onchange="displayNotes()">
        <option value="">Select AHJ</option>
    </select>

    <label for="utility">Utility:</label>
    <select id="utility" onchange="displayNotes()">
        <option value="">Select Utility</option>
    </select>

    <!-- Sections for Notes -->
    <h3>PV01 - Cover Page:</h3>
    <div id="pv01-container" class="note-container"></div>

    <h3>PV02 - Site Plan:</h3>
    <div id="pv02-container" class="note-container"></div>

    <h3>PV03 - Roof Plan:</h3>
    <div id="pv03-container" class="note-container"></div>

    <h3>PV04 - Mounting Detail:</h3>
    <div id="pv04-container" class="note-container"></div>

    <h3>PV05 - Line Diagram - Mounting Detail:</h3>
    <div id="pv05-container" class="note-container"></div>

    <h3>PV06 - Electrical Calcs:</h3>
    <div id="pv06-container" class="note-container"></div>

    <h3>PV07 - Electrical Calcs:</h3>
    <div id="pv07-container" class="note-container"></div>

    <h3>PV08 - Placard:</h3>
    <div id="pv08-container" class="note-container"></div>

    <h3>PV09 - Placard:</h3>
    <div id="pv09-container" class="note-container"></div>

    <script>
        const sheetUrl = "https://script.google.com/macros/s/AKfycbzj8W27g0vG13vaXT2q40qTXOqsuBz8qvNW_IB3oFuZWOJRMZKajnZeMTsvpnVVY3iv/exec";

        let ahjData = [];
        let utilityData = [];

async function fetchData() {
    try {
        console.log("Fetching data from Google Apps Script..."); // Debugging log
        const response = await fetch(sheetUrl);

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        console.log("Data fetched successfully:", data); // Log fetched data

        ahjData = data.ahjData || [];
        utilityData = data.utilityData || [];

        console.log("AHJ Data:", ahjData);
        console.log("Utility Data:", utilityData);

        populateStateDropdown();
    } catch (error) {
        console.error("Error fetching data:", error);
    }
}

fetchData();

        function updateAHJAndUtility() {
            const selectedState = document.getElementById("state").value;
            const ahjDropdown = document.getElementById("ahj");
            const utilityDropdown = document.getElementById("utility");

            ahjDropdown.innerHTML = '<option value="">Select AHJ</option>';
            utilityDropdown.innerHTML = '<option value="">Select Utility</option>';

            ahjData.filter(item => item.state === selectedState).forEach(item => {
                let option = document.createElement("option");
                option.value = item.ahj;
                option.textContent = item.ahj;
                ahjDropdown.appendChild(option);
            });

            utilityData.filter(item => item.state === selectedState).forEach(item => {
                let option = document.createElement("option");
                option.value = item.utility;
                option.textContent = item.utility;
                utilityDropdown.appendChild(option);
            });
        }

function displayNotes() {
    const selectedAHJ = document.getElementById("ahj").value;
    const selectedUtility = document.getElementById("utility").value;

    // Clear previous notes
    for (let i = 1; i <= 9; i++) {
        let section = document.getElementById(`pv0${i}-container`);
        if (section) section.innerHTML = "";
    }

    // Find AHJ and Utility data
    const ahjDataItem = ahjData.find(item => item.ahj === selectedAHJ);
    const utilityDataItem = utilityData.find(item => item.utility === selectedUtility);

    // ✅ Display AHJ Notes
    if (ahjDataItem && ahjDataItem.ahjNote) {
        ahjDataItem.ahjNote.split("&").forEach(note => {
            displayFormattedNote(note);
        });
    } else {
        console.warn("No AHJ notes found for:", selectedAHJ);
    }

    // ✅ Display Utility Notes
    if (utilityDataItem && utilityDataItem.utilityNote) {
        utilityDataItem.utilityNote.split("&").forEach(note => {
            displayFormattedNote(note);
        });
    } else {
        console.warn("No Utility notes found for:", selectedUtility);
    }
}

        }
function displayFormattedNote(note) {
    let trimmedNote = note.trim();
    let urlMatch = trimmedNote.match(/(https?:\/\/[^\s]+)/); // Detect URLs
    let category = trimmedNote.match(/(UPV\d+|PV\d+)/); // Detect PV category

    if (category) {
        let sectionId = category[0].toLowerCase().replace("upv", "pv") + "-container"; // Convert UPV01 → PV01
        let section = document.getElementById(sectionId);

        if (section) {
            let noteItem = document.createElement("div");
            noteItem.className = "note-item";

            let checkbox = document.createElement("input");
            checkbox.type = "checkbox";

            let labelText = trimmedNote.replace(/(UPV\d+:|PV\d+:)/, "").trim(); // Remove PV labels
            labelText = labelText.replace(/(https?:\/\/[^\s]+)/, "").trim(); // Remove URL from text

            let label = document.createElement("label");
            label.textContent = labelText;

            noteItem.appendChild(checkbox);
            noteItem.appendChild(label);

            // ✅ Convert URL to Help Icon
            if (urlMatch) {
                let helpLink = document.createElement("a");
                helpLink.href = urlMatch[0];
                helpLink.target = "_blank";
                helpLink.className = "help-icon";
                helpLink.innerHTML = "ℹ"; // Info icon
                noteItem.appendChild(helpLink);
            }

            section.appendChild(noteItem);
        }
    }
}

        }
    </script>

</body>
</html>
