<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dropdown from Google Sheets</title>
    <style>
        body { font-family: Arial, sans-serif; }
        select, div { margin-top: 10px; }
        .note-container { margin-top: 10px; }
        .note-item { display: flex; align-items: center; margin-bottom: 5px; }
        .note-item input { margin-right: 5px; }
        
        /* Help Icon Styling */
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            font-size: 14px;
            font-weight: bold;
            color: white;
            background-color: blue;
            border-radius: 50%; /* Circular Shape */
            text-decoration: none;
            margin-left: 8px;
            cursor: pointer;
        }

        .help-icon:hover {
            background-color: darkblue;
        }
    </style>
</head>
<body>

    <h2>Select a State and AHJ</h2>
    <label for="state">State:</label>
    <select id="state" onchange="updateAHJ()">
        <option value="">Select State</option>
    </select>

    <label for="ahj">AHJ:</label>
    <select id="ahj" onchange="displayNote()">
        <option value="">Select AHJ</option>
    </select>
    
    <label for="utility">Utility:</label>
    <select id="utility" onchange="displayUtilityNotes()">
        <option value="">Select Utility</option>
    </select>


    <!-- Sections for Notes -->
    <h3>PV01 - Cover Page:</h3>
    <div id="pv01-container" class="note-container"></div>

    <h3>PV02 - Site Plan:</h3>
    <div id="pv02-container" class="note-container"></div>

    <h3>PV03 - Roof Plan:</h3>
    <div id="pv03-container" class="note-container"></div>

    <h3>PV04 - Mounting Detail:</h3>
    <div id="pv04-container" class="note-container"></div>

    <h3>PV05 - Line Diagram - Mounting Detail:</h3>
    <div id="pv05-container" class="note-container"></div>

    <h3>PV06 - Electrical Calcs:</h3>
    <div id="pv06-container" class="note-container"></div>

    <h3>PV07 - Electrical Calcs:</h3>
    <div id="pv07-container" class="note-container"></div>

    <h3>PV08 - Placard:</h3>
    <div id="pv08-container" class="note-container"></div>

    <h3>PV09 - Placard:</h3>
    <div id="pv09-container" class="note-container"></div>

    <script>
     const sheetUrl = "https://script.google.com/macros/s/AKfycbwFlbG1B2V5EFMYa01aQtxYelK_K71wyTk_xnDNtp39sAfTtjP0sdCsxkOFnC3GezrV/exec"; // Replace with your deployed script URL

        let ahjData = [];
        let utilityData = [];

    async function fetchData() {
        const response = await fetch(sheetUrl);
        const data = await response.json();
        ahjData = data.ahjData;
        utilityData = data.utilityData;

        // Populate State Dropdown
        const states = [...new Set([...ahjData.map(item => item.state), ...utilityData.map(item => item.state)])];
        const stateDropdown = document.getElementById("state");

        states.forEach(state => {
            let option = document.createElement("option");
            option.value = state;
            option.textContent = state;
            stateDropdown.appendChild(option);
    });
}


function updateAHJ() {
    const selectedState = document.getElementById("state").value;
    const ahjDropdown = document.getElementById("ahj");
    const utilityDropdown = document.getElementById("utility");

    ahjDropdown.innerHTML = '<option value="">Select AHJ</option>';
    utilityDropdown.innerHTML = '<option value="">Select Utility</option>'; // Reset Utility Dropdown

    const filteredAHJs = ahjData.filter(item => item.state === selectedState);
    const filteredUtilities = utilityData.filter(item => item.state === selectedState);

    filteredAHJs.forEach(item => {
        let option = document.createElement("option");
        option.value = item.ahj;
        option.textContent = item.ahj;
        ahjDropdown.appendChild(option);
    });

    filteredUtilities.forEach(item => {
        let option = document.createElement("option");
        option.value = item.utility;
        option.textContent = item.utility;
        utilityDropdown.appendChild(option);
    });
}


function displayNote() {
    const selectedAHJ = document.getElementById("ahj").value;
    
    // Clear previous notes
    for (let i = 1; i <= 9; i++) {
        let section = document.getElementById(`pv0${i}-container`);
        if (section) section.innerHTML = "";
    }

    const foundData = ahjData.find(item => item.ahj === selectedAHJ);

    if (foundData && foundData.ahjNote) {
        foundData.ahjNote.split("&").forEach(note => {
            displayFormattedNote(note);
        });
    }
}

function displayUtilityNotes() {
    const selectedUtility = document.getElementById("utility").value;
    
    // Clear previous utility notes
    for (let i = 1; i <= 9; i++) {
        let section = document.getElementById(`pv0${i}-container`);
        if (section) section.innerHTML = "";
    }

    const foundData = utilityData.find(item => item.utility === selectedUtility);

    if (foundData && foundData.utilityNote) {
        foundData.utilityNote.split("&").forEach(note => {
            displayFormattedNote(note);
        });
    }
}

function displayFormattedNote(note) {
    let trimmedNote = note.trim();
    let urlMatch = trimmedNote.match(/(https?:\/\/[^\s]+)/); // Detect URLs
    let category = trimmedNote.match(/UPV\d+/); // Detect Utility PV Categories

    if (category) {
        let sectionId = category[0].toLowerCase().replace("upv", "pv") + "-container"; // Convert UPV01 → PV01
        let section = document.getElementById(sectionId);

        if (section) {
            let noteItem = document.createElement("div");
            noteItem.className = "note-item";

            let checkbox = document.createElement("input");
            checkbox.type = "checkbox";

            // Remove PVXX: and URLs from the note
            let labelText = trimmedNote.replace(/UPV\d+:/, "").trim();
            labelText = labelText.replace(/(https?:\/\/[^\s]+)/, "").trim();

            let label = document.createElement("label");
            label.textContent = labelText;

            noteItem.appendChild(checkbox);
            noteItem.appendChild(label);

            // If a URL is detected, add a help icon
            if (urlMatch) {
                let helpLink = document.createElement("a");
                helpLink.href = urlMatch[0];
                helpLink.target = "_blank";
                helpLink.className = "help-icon";
                helpLink.innerHTML = "ℹ"; // Info icon
                noteItem.appendChild(helpLink);
            }

            section.appendChild(noteItem);
        }
    }
}


        fetchData();
    </script>

</body>
</html>
