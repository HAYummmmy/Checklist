<script>
    const sheetUrl = "https://script.google.com/macros/s/AKfycbxUy0pCwOmT1X_bzXCuiBj-0c1tEhb9j0vrbBhgo-dl5hd5x1cHRIgNb3lqDLx6CK48/exec"; // Use your correct deployed script URL

    let allData = [];

    async function fetchData() {
        const response = await fetch(sheetUrl);
        const data = await response.json();
        allData = data;

        const states = [...new Set(data.map(item => item.state))];
        const stateDropdown = document.getElementById("state");

        states.forEach(state => {
            let option = document.createElement("option");
            option.value = state;
            option.textContent = state;
            stateDropdown.appendChild(option);
        });
    }

    function updateAHJ() {
        const selectedState = document.getElementById("state").value;
        const ahjDropdown = document.getElementById("ahj");

        ahjDropdown.innerHTML = '<option value="">Select AHJ</option>';

        const filteredAHJs = allData.filter(item => item.state === selectedState);

        filteredAHJs.forEach(item => {
            let option = document.createElement("option");
            option.value = item.ahj;
            option.textContent = item.ahj;
            ahjDropdown.appendChild(option);
        });
    }

    function displayNote() {
        const selectedAHJ = document.getElementById("ahj").value;
        
        // Clear previous notes
        for (let i = 1; i <= 9; i++) {
            let section = document.getElementById(`pv0${i}-container`);
            if (section) section.innerHTML = "";
        }

        const foundData = allData.find(item => item.ahj === selectedAHJ);

        if (foundData && foundData.note) {
            let notesArray = foundData.note.split("&");

            notesArray.forEach(note => {
                let trimmedNote = note.trim();
                let urlMatch = trimmedNote.match(/(https?:\/\/[^\s]+)/); // Detect URLs
                let category = trimmedNote.match(/PV\d+/);
                let textColor = foundData.color || "#000000"; // Default to black if no color

                if (category) {
                    let sectionId = category[0].toLowerCase() + "-container";
                    let section = document.getElementById(sectionId);

                    if (section) {
                        let noteItem = document.createElement("div");
                        noteItem.className = "note-item";

                        let checkbox = document.createElement("input");
                        checkbox.type = "checkbox";

                        // Remove PVXX: and URLs from the note
                        let labelText = trimmedNote.replace(/PV\d+:/, "").trim();
                        labelText = labelText.replace(/(https?:\/\/[^\s]+)/, "").trim();

                        let label = document.createElement("label");
                        label.textContent = labelText;
                        label.style.color = textColor; // Apply Google Sheets text color

                        noteItem.appendChild(checkbox);
                        noteItem.appendChild(label);

                        // If a URL is detected, add a help icon (without showing the URL)
                        if (urlMatch) {
                            let helpLink = document.createElement("a");
                            helpLink.href = urlMatch[0]; // Use the detected URL
                            helpLink.target = "_blank";
                            helpLink.className = "help-icon";
                            helpLink.innerHTML = "â„¹"; // Info icon
                            noteItem.appendChild(helpLink);
                        }

                        section.appendChild(noteItem);
                    }
                }
            });
        }
    }

    fetchData();
</script>
